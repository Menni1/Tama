<!DOCTYPE html>
<html lang="de">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="format-detection" content="telephone=no">
<title>Tamagotchi ‚Äì Kompakt App (Onefile)</title>
<style>
/* =============================
   iPhone-native Look ‚Äì High Contrast, Readable
   ============================= */
:root{
  --bg: #0b0d10;
  --surface: #141820;
  --card: #1b2130;
  --border: #2a3242;
  --fg: #ecf1f7;
  --muted: #aab4c3;
  --accent: #2f7af7;
  --good: #18c37b;
  --warn: #f0b429;
  --bad: #e65353;
  --sat: #19c37d;   /* S√§ttigung (invertierter Hunger) */
  --en:  #2f7af7;   /* Energie */
  --hy:  #00a3a3;   /* Hygiene */
  --shadow: 0 8px 24px rgba(0,0,0,.35);
}
@media (prefers-color-scheme: light){
  :root{
    --bg:#f6f8fb; --surface:#ffffff; --card:#ffffff; --border:#e5e8ef;
    --fg:#0b0d10; --muted:#566072; --accent:#2f6cf7;
    --good:#0f9d68; --warn:#c9850b; --bad:#c63737;
    --sat:#0f9d68; --en:#2f6cf7; --hy:#0a8a8a;
    --shadow: 0 6px 18px rgba(0,0,0,.08);
  }
}
*{box-sizing:border-box}
html,body{height:100%}
body{
  margin:0; font-family: ui-sans-serif, -apple-system, BlinkMacSystemFont, "SF Pro", Segoe UI, Roboto, Ubuntu;
  background: var(--bg); color: var(--fg);
  -webkit-font-smoothing: antialiased;
  -webkit-tap-highlight-color: transparent;
}
/* App container with safe-area paddings */
.app{
  max-width: 880px;
  margin: 0 auto;
  padding: calc(12px + env(safe-area-inset-top)) 16px calc(88px + env(safe-area-inset-bottom));
}
/* Top bar */
.nav{
  position: sticky; top: 0; z-index: 10;
  margin: calc(-12px - env(safe-area-inset-top)) -16px 12px;
  padding: calc(10px + env(safe-area-inset-top)) 16px 10px;
  background: var(--surface);
  border-bottom: 1px solid var(--border);
}
.title{margin:0; font-size:20px; font-weight:800; letter-spacing:.2px}
.sub{color:var(--muted); font-size:12px}
/* Cards */
.card{
  background: var(--card);
  border: 1px solid var(--border);
  border-radius: 16px;
  padding: 14px;
  margin: 12px 0;
  box-shadow: var(--shadow);
}
/* Layout helpers */
.grid{display:grid; gap:12px}
.cols-2{grid-template-columns: repeat(2, minmax(0,1fr))}
.cols-3{grid-template-columns: repeat(3, minmax(0,1fr))}
.flex{display:flex; gap:12px; align-items:center; flex-wrap:wrap}
.center{display:flex; align-items:center; justify-content:center}
.row{display:flex; gap:8px; align-items:center; flex-wrap:wrap}
.grow{flex:1}
.tiny{font-size:12px}
.mono{font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, monospace}
.muted{color: var(--muted)}
/* Pet hero */
.pet{
  min-width:240px; aspect-ratio: 1/1; border-radius: 18px; position: relative; overflow: hidden;
  background: linear-gradient(180deg, #1e2533, #141b28);
  border:1px solid var(--border);
  box-shadow: var(--shadow);
}
.pet .face{position:absolute; left:50%; top:44%; transform:translate(-50%,-50%); text-align:center}
.pet .emoji{font-size:72px; line-height:72px}
.pet .name{margin-top:8px; font-weight:800; font-size:16px}
.pet .meta{margin-top:4px; font-size:12px; color:var(--muted)}
/* Simple, accessible meters */
.meter{
  width:100%; height:22px; border-radius:999px; background: #0e1320;
  border: 1px solid var(--border); overflow:hidden; position:relative;
}
.fill{
  height:100%; width:0%; transition: width .35s ease;
  background: var(--accent);
}
.meter .label{
  position:absolute; inset:0; display:flex; align-items:center; justify-content:space-between;
  padding:0 10px; font-weight:700; font-size:12px; color:#fff;
}
.meter.sat .fill{ background: linear-gradient(90deg, var(--sat), #77e2b3); }
.meter.en  .fill{ background: linear-gradient(90deg, var(--en), #7fb1ff); }
.meter.hy  .fill{ background: linear-gradient(90deg, var(--hy), #44d9d9); }
/* Buttons */
.btn,.action{
  border:1px solid var(--border); border-radius:12px; padding:12px 14px; font-weight:800;
  background: var(--accent); color:#fff; cursor:pointer; width:100%;
  box-shadow: var(--shadow);
}
.btn.secondary{ background: transparent; color: var(--fg) }
.btn.ghost{ background: transparent; color: var(--muted); border-style:dashed }
.btn:active,.action:active{ transform: translateY(1px) }
/* Inputs */
input[type="text"]{
  width:100%; padding:12px; border-radius:12px; border:1px solid var(--border);
  background: var(--surface); color:var(--fg);
}
label{font-size:12px; color:var(--muted)}
/* Toolbar (bottom) */
.toolbar{
  position: fixed; left:0; right:0; bottom:0; z-index: 15;
  padding: 10px 16px calc(10px + env(safe-area-inset-bottom));
  background: var(--surface); border-top: 1px solid var(--border);
}
.toolbar .bar{
  max-width:880px; margin:0 auto;
  display:grid; gap:10px; grid-template-columns: repeat(4, minmax(0,1fr));
}
.action{ background: var(--surface); color: var(--fg) }
.action.primary{ background: var(--accent); color:#fff }
/* Responsive */
@media (max-width:860px){
  .cols-3{grid-template-columns: 1fr 1fr}
}
@media (max-width:640px){
  .cols-2{grid-template-columns:1fr}
  .cols-3{grid-template-columns:1fr}
}
/* Accessibility tweaks */
@media (prefers-reduced-motion: reduce){
  .fill{ transition: none }
}
</style>
</head>
<body>
<div class="app" role="application" aria-label="Tamagotchi App">
  <div class="nav" role="banner">
    <h1 class="title">Tamagotchi</h1>
    <div class="sub">Onefile ‚Ä¢ iPhone-optimiert ‚Ä¢ Offline</div>
  </div>

  <div class="card flex" role="region" aria-label="Haustier und Werte">
    <div class="pet center grow" aria-live="polite">
      <div class="face">
        <div id="emoji" class="emoji" aria-label="Stimmung">üòÄ</div>
        <div id="petName" class="name">Mein Haustier</div>
        <div class="meta" id="meta"><span id="ageLabel">0 Tage alt</span> ‚Ä¢ <span id="moodLabel">Laune: ok</span></div>
      </div>
    </div>

    <div class="grid grow" style="min-width:260px">
      <div class="grid">
        <div class="meter sat" aria-label="S√§ttigung">
          <div class="fill" id="satFill" style="width:0%"></div>
          <div class="label"><span>üçé S√§ttigung</span><span id="satVal">0%</span></div>
        </div>
        <button class="btn" data-act="feed" aria-label="F√ºttern">üçé F√ºttern</button>
      </div>

      <div class="grid">
        <div class="meter en" aria-label="Energie">
          <div class="fill" id="enFill" style="width:0%"></div>
          <div class="label"><span>‚ö° Energie</span><span id="enVal">0%</span></div>
        </div>
        <button class="btn" data-act="sleep" aria-label="Schlafen">üò¥ Schlafen</button>
      </div>

      <div class="grid">
        <div class="meter hy" aria-label="Hygiene">
          <div class="fill" id="hyFill" style="width:0%"></div>
          <div class="label"><span>ü´ß Hygiene</span><span id="hyVal">0%</span></div>
        </div>
        <button class="btn" data-act="wash" aria-label="Waschen">ü´ß Waschen</button>
      </div>
    </div>
  </div>

  <div class="card grid cols-2" role="region" aria-label="Interaktion">
    <div class="grid">
      <label for="newName">Name</label>
      <input id="newName" type="text" placeholder="Name eingeben‚Ä¶" maxlength="24">
      <button class="btn secondary" id="renameBtn" aria-label="Umbenennen">Umbenennen</button>
    </div>
    <div class="grid">
      <div class="row muted tiny" aria-hidden="true"><span>üéÆ</span><b style="margin-left:6px">Spielen</b><span style="margin-left:6px">(+Laune, ‚àíEnergie)</span></div>
      <button class="btn" data-act="play" aria-label="Spielen">Jetzt spielen</button>
      <div class="tiny muted">Tipp: Regelm√§√üig √∂ffnen h√§lt dein Haustier gl√ºcklich.</div>
    </div>
  </div>

  <div class="card grid" role="region" aria-label="Weitergeben">
    <b>Weitergeben</b>
    <div class="muted tiny">Exportiere den Status als Code und schicke ihn weiter. Freund:innen k√∂nnen ihn importieren und weiterpflegen (ohne Server).</div>
    <div class="grid cols-2">
      <div class="grid">
        <button class="btn secondary" id="exportBtn" aria-label="Zustand exportieren">Zustand exportieren</button>
        <div id="exportOut" class="mono tiny" style="word-break:break-all"></div>
        <button class="btn ghost" id="copyBtn" aria-label="Code kopieren">Code kopieren</button>
      </div>
      <div class="grid">
        <input id="importIn" type="text" placeholder="Code hier einf√ºgen‚Ä¶" aria-label="Import-Code">
        <button class="btn" id="importBtn" aria-label="Importieren">Importieren</button>
      </div>
    </div>
  </div>

  <div class="card grid" role="region" aria-label="Protokoll">
    <b>Protokoll</b>
    <div id="log" class="tiny mono" style="white-space:pre-wrap; max-height:180px; overflow:auto"></div>
    <div class="row">
      <button class="btn secondary" id="clearLog" aria-label="Protokoll leeren">Protokoll leeren</button>
      <button class="btn ghost" id="resetBtn" aria-label="Zur√ºcksetzen">Zur√ºcksetzen</button>
    </div>
  </div>
</div>

<!-- Bottom Action Bar -->
<div class="toolbar" role="contentinfo">
  <div class="bar">
    <button class="action" data-act="feed" aria-label="F√ºttern">üçé F√ºttern</button>
    <button class="action" data-act="play" aria-label="Spielen">üé≤ Spielen</button>
    <button class="action" data-act="wash" aria-label="Waschen">ü´ß Waschen</button>
    <button class="action primary" data-act="sleep" aria-label="Schlafen">üò¥ Schlafen</button>
  </div>
</div>

<script>
/* =============================
   Logik (unver√§ndert robust, aber UI auf Meters)
   ============================= */
(function(){
  const $ = s => document.querySelector(s);
  const logEl = $("#log");
  const KEY = "tamaState_readable_v1";
  const clamp = (v, min, max) => Math.max(min, Math.min(max, v));

  function checksum(str){
    let h=0; for(let i=0;i<str.length;i++){ h=(h*131+str.charCodeAt(i))>>>0; } return h.toString(36);
  }
  function load(){
    const raw = localStorage.getItem(KEY);
    if(!raw){
      const now = Date.now();
      return { name:"Mein Haustier", birthday: now, lastSeen: now, alive:true,
               hunger: 28, energy: 72, hygiene: 70, happiness: 72,
               ageDays: 0, stage:1, log:[] };
    }
    try{ return JSON.parse(raw); }catch{ localStorage.removeItem(KEY); return load(); }
  }
  function save(s){ localStorage.setItem(KEY, JSON.stringify(s)); }
  let S = load();

  // Zeitverfall
  function applyDecay(){
    const now = Date.now();
    const hours = Math.max(0, (now - S.lastSeen)/36e5);
    if(hours < 0.01) return;
    const hungerUp=6, energyDown=5, hygieneDown=3, moodDrift=2;
    S.hunger = clamp(S.hunger + hungerUp*hours, 0, 100);
    S.energy = clamp(S.energy - energyDown*hours, 0, 100);
    S.hygiene = clamp(S.hygiene - hygieneDown*hours, 0, 100);
    const penalty = (S.hunger*0.35) + ((100 - S.energy)*0.25) + ((100 - S.hygiene)*0.20) + hours*moodDrift;
    S.happiness = clamp(100 - penalty, 0, 100);
    const ageDays = Math.floor((now - S.birthday)/86400000);
    if(ageDays !== S.ageDays){
      S.ageDays = ageDays;
      pushLog(`üéÇ Tag ${S.ageDays}: wieder ein St√ºck gewachsen.`);
      if (S.ageDays === 3) S.stage = 2;
      if (S.ageDays === 7) S.stage = 3;
    }
    if (S.hunger >= 100 && hours > 6){
      S.alive = false;
      pushLog("üí® Dein Haustier ist auf Reisen gegangen (Vernachl√§ssigung). Innerhalb 24h in einem Freundes-Browser importieren, um es zur√ºckzuholen.");
    }
    S.lastSeen = now; save(S);
  }

  // UI
  function faceByMood(){
    if(!S.alive) return "ü•∫";
    if (S.happiness > 80) return "ü§©";
    if (S.happiness > 60) return "üòÄ";
    if (S.happiness > 40) return "üôÇ";
    if (S.happiness > 20) return "üòï";
    return "üò¢";
  }
  function moodLabel(){
    const v = Math.round(S.happiness);
    if(!S.alive) return "unterwegs‚Ä¶";
    if (v>80) return "gl√ºcklich";
    if (v>60) return "gut";
    if (v>40) return "ok";
    if (v>20) return "m√ºde";
    return "traurig";
  }

  function setMeter(id, val){
    const elFill = $("#" + id + "Fill");
    const elVal  = $("#" + id + "Val");
    const v = clamp(val, 0, 100);
    elFill.style.width = v + "%";
    elVal.textContent = Math.round(v) + "%";
  }

  function render(){
    $("#petName").textContent = S.name || "Mein Haustier";
    $("#emoji").textContent = faceByMood();
    $("#ageLabel").textContent = `${S.ageDays} Tage alt`;
    $("#moodLabel").textContent = `Laune: ${moodLabel()}`;
    setMeter("sat", 100 - S.hunger); // S√§ttigung = invertierter Hunger
    setMeter("en", S.energy);
    setMeter("hy", S.hygiene);
  }

  function pushLog(msg){
    const t = new Date().toLocaleString();
    S.log.unshift(`[${t}] ${msg}`);
    S.log = S.log.slice(0,200);
    logEl.textContent = S.log.join("\\n");
    save(S);
  }

  // Aktionen + Cooldowns
  const cooldowns = { feed: 5*60*1000, play: 5*60*1000, wash: 10*60*1000, sleep: 10*60*1000 };
  const lastAction = { feed:0, play:0, wash:0, sleep:0 };
  const canAct = k => (Date.now() - lastAction[k]) >= cooldowns[k];
  const markAct = k => (lastAction[k] = Date.now());

  const actions = {
    feed(){
      if(!S.alive) return alert("Es ist unterwegs‚Ä¶ importiere den Code in einem Freundes-Browser, um es zur√ºckzuholen.");
      if(!canAct("feed")) return alert("Noch satt. Versuch es sp√§ter.");
      const before = S.hunger;
      S.hunger = clamp(S.hunger - 35, 0, 100);
      S.happiness = clamp(S.happiness + 8, 0, 100);
      markAct("feed"); pushLog(`üçé Gef√ºttert (${Math.round(before)} ‚Üí ${Math.round(S.hunger)} Hunger).`);
    },
    play(){
      if(!S.alive) return alert("Es ist unterwegs‚Ä¶");
      if(!canAct("play")) return alert("Noch am Spielen!");
      S.happiness = clamp(S.happiness + 18, 0, 100);
      S.energy = clamp(S.energy - 12, 0, 100);
      S.hygiene = clamp(S.hygiene - 6, 0, 100);
      markAct("play"); pushLog("üé≤ Gemeinsam gespielt (+Laune, ‚àíEnergie, ‚àíHygiene).");
    },
    wash(){
      if(!S.alive) return alert("Es ist unterwegs‚Ä¶");
      if(!canAct("wash")) return alert("Schon sauber genug.");
      S.hygiene = clamp(S.hygiene + 28, 0, 100);
      S.happiness = clamp(S.happiness + 4, 0, 100);
      markAct("wash"); pushLog("ü´ß Gewaschen (+Hygiene).");
    },
    sleep(){
      if(!S.alive) return alert("Es ist unterwegs‚Ä¶");
      if(!canAct("sleep")) return alert("Noch wach. Warte etwas.");
      const rest = 20 + Math.random()*15;
      S.energy = clamp(S.energy + rest, 0, 100);
      S.hunger = clamp(S.hunger + 6, 0, 100);
      S.happiness = clamp(S.happiness + 6, 0, 100);
      markAct("sleep"); pushLog("üò¥ Ein Nickerchen gemacht (+Energie, +Laune, +Hunger).");
    }
  };

  // Export / Import
  function exportCode(){
    const payload = JSON.stringify({
      name:S.name, birthday:S.birthday, lastSeen:Date.now(), alive:S.alive,
      hunger:S.hunger, energy:S.energy, hygiene:S.hygiene, happiness:S.happiness,
      ageDays:S.ageDays, stage:S.stage
    });
    const sig = checksum(payload);
    return btoa(unescape(encodeURIComponent(JSON.stringify({p:payload, s:sig}))));
  }
  function importCode(code){
    try{
      const obj = JSON.parse(decodeURIComponent(escape(atob(code))));
      if (checksum(obj.p) !== obj.s) throw new Error("bad checksum");
      const data = JSON.parse(obj.p);
      const within = Date.now() - (data.lastSeen||Date.now());
      if (data.alive === false && within <= 86400000){ data.alive = true; pushLog("üß≠ Zur√ºck von der Reise!"); }
      S = Object.assign(S, data, { lastSeen: Date.now() });
      save(S); render(); pushLog("üì• Zustand importiert."); return true;
    }catch(e){ alert("Ung√ºltiger Code."); return false; }
  }

  // Event wiring
  document.querySelectorAll("[data-act]").forEach(btn => {
    const kind = btn.getAttribute("data-act");
    const handler = () => { actions[kind](); save(S); render(); };
    btn.addEventListener("click", handler, {passive:true});
    btn.addEventListener("touchstart", handler, {passive:true});
  });
  $("#renameBtn").addEventListener("click", ()=>{
    const v = $("#newName").value.trim();
    if (v){ S.name=v; save(S); render(); pushLog(`‚úèÔ∏è Umbenannt in ‚Äû${v}‚Äú.`); }
  }, {passive:true});
  $("#exportBtn").addEventListener("click", ()=>{ $("#exportOut").textContent = exportCode(); }, {passive:true});
  $("#copyBtn").addEventListener("click", async ()=>{
    const t = $("#exportOut").textContent.trim(); if(!t) return;
    try{ await navigator.clipboard.writeText(t); alert("Code kopiert!"); }catch{ alert("Kopieren nicht m√∂glich. Markiere den Code manuell."); }
  }, {passive:true});
  $("#importBtn").addEventListener("click", ()=>{
    const code = $("#importIn").value.trim(); if(code) importCode(code);
  }, {passive:true});
  $("#clearLog").addEventListener("click", ()=>{ S.log=[]; save(S); logEl.textContent=""; }, {passive:true});
  $("#resetBtn").addEventListener("click", ()=>{
    if(confirm("Wirklich alles zur√ºcksetzen?")){
      localStorage.removeItem(KEY); S = load(); save(S); render(); pushLog("üîÑ Zur√ºckgesetzt.");
    }
  }, {passive:true});

  // Init
  applyDecay(); render(); logEl.textContent = (S.log||[]).join("\\n");
})();
</script>
</body>
</html>
